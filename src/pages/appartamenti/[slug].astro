---
/**
 * Dynamic Property Page
 * Generates pages for all properties from YAML configuration
 *
 * This dynamic route loads content from YAML property files
 * and generates a page for each property.
 */
import Layout from '~/layouts/PageLayout.astro';
import ApartmentHero from '~/components/appartamenti/ApartmentHero.astro';
import PropertyOverview from '~/components/appartamenti/PropertyOverview.astro';
import RoomShowcase from '~/components/appartamenti/RoomShowcase.astro';
import PhotoGallery from '~/components/appartamenti/PhotoGallery.astro';
import ServicesGrid from '~/components/appartamenti/ServicesGrid.astro';
import Testimonials from '~/components/widgets/Testimonials.astro';
import Benefits from '~/components/appartamenti/Benefits.astro';
import ApartmentCTA from '~/components/appartamenti/ApartmentCTA.astro';

import { getProperties, getPropertyBySlug } from '~/utils/properties';
import { getSiteName, getSiteUrl } from '~/config';
import { getApartmentsContent, getCurrentLocale } from '~/utils/content';

// Generate static paths for all properties
export async function getStaticPaths() {
  const properties = await getProperties();

  return properties.map((property) => ({
    params: { slug: property.slug },
  }));
}

// Get the property for this page
const { slug } = Astro.params;
const property = await getPropertyBySlug(slug);

if (!property) {
  return Astro.redirect('/404');
}

// Get current locale from URL
const currentLocale = getCurrentLocale(Astro.url);

// Load content dictionary for apartments with locale
const apartmentsContent = await getApartmentsContent(currentLocale);
const siteName = getSiteName();
const siteUrl = getSiteUrl();

// SEO metadata - use property's SEO config or generate defaults
const metadata = {
  title: property.seo?.title || `${property.name} - ${property.subtitle} | ${siteName}`,
  description: property.seo?.description || `${property.description.substring(0, 155)}...`,
  canonical: `${siteUrl}/appartamenti/${property.slug}`,
  openGraph: {
    title: property.seo?.title || property.name,
    description: property.seo?.description || property.subtitle,
    type: 'website',
    url: `${siteUrl}/appartamenti/${property.slug}`,
    image: property.seo?.image,
  },
};

const testimonials = (apartmentsContent.testimonials?.reviews || []).map((review) => ({
  testimonial: review.text,
  name: review.name,
  job: review.country,
}));
---

<Layout metadata={metadata}>
  <!-- Hero Section -->
  <ApartmentHero
    title={property.name}
    subtitle={property.subtitle || ''}
    heroImage={property.images.hero}
    apartmentId={property.id}
  />

  <!-- Property Overview Section -->
  <PropertyOverview
    description={property.description}
    propertyImage={property.images.thumbnail}
    apartmentId={property.id}
    capacity={property.capacity.guests}
    size={property.size.value}
    sizeUnit={property.size.unit}
    bedrooms={property.capacity.bedrooms.toString()}
    bathrooms={property.capacity.bathrooms.toString()}
  />

  <!-- Room-by-Room Showcase -->
  <RoomShowcase rooms={property.rooms} apartmentId={property.id} />

  <!-- Photo Gallery -->
  <PhotoGallery apartmentSlug={property.slug} apartmentName={property.name} />

  <!-- Services Grid -->
  <ServicesGrid />

  <!-- Testimonials Section -->
  <Testimonials
    id="testimonianze"
    title={apartmentsContent.testimonials?.title || "Cosa dicono i nostri ospiti"}
    subtitle={apartmentsContent.testimonials?.subtitle || "La soddisfazione dei nostri ospiti è la nostra priorità. Ecco cosa raccontano."}
    testimonials={testimonials}
  />

  <!-- Benefits Section (Trentino Guest Card) -->
  <Benefits />

  <!-- Call to Action -->
  <ApartmentCTA apartmentName={property.name} />
</Layout>
