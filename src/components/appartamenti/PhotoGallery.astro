---
/**
 * Photo Gallery Component
 * Displays an image carousel of all apartment photos
 *
 * Images are loaded dynamically from: src/assets/images/{apartmentSlug}/
 */
import { getImage } from 'astro:assets';
import ImageCarousel from '~/components/widgets/ImageCarousel.astro';
import { getApartmentsContent } from '~/utils/content';

export interface Props {
  apartmentSlug: string;
  apartmentName: string;
}

const { apartmentSlug, apartmentName } = Astro.props;
const apartmentsContent = await getApartmentsContent();

// Dynamic image loading using import.meta.glob
// This loads all webp images from all property folders
const allImages = import.meta.glob<{ default: ImageMetadata }>(
  '../../assets/images/**/*.webp',
  { eager: true }
);

// Filter images for the current property
const propertyImages = Object.entries(allImages)
  .filter(([path]) => path.includes(`/${apartmentSlug}/`))
  .map(([_, module]) => module.default);

if (propertyImages.length === 0) {
  console.warn(`No images found for property: ${apartmentSlug}`);
}

// Generate optimized images
const images = await Promise.all(
  propertyImages.map(async (originalImage, index) => {
    // Generate thumbnail for carousel
    const thumbnail = await getImage({
      src: originalImage,
      width: 800,
      format: 'webp',
      quality: 85,
    });

    const thumbnail1200 = await getImage({
      src: originalImage,
      width: 1200,
      format: 'webp',
      quality: 85,
    });

    // Generate full-size for modal
    const full = await getImage({
      src: originalImage,
      width: 1600,
      format: 'webp',
      quality: 90,
    });

    const full2400 = await getImage({
      src: originalImage,
      width: 2400,
      format: 'webp',
      quality: 90,
    });

    return {
      src: thumbnail.src,
      srcset: `${thumbnail.src} 800w, ${thumbnail1200.src} 1200w`,
      sizes: '(max-width: 768px) 100vw, 800px',
      fullSrc: full.src,
      fullSrcset: `${thumbnail1200.src} 1200w, ${full.src} 1600w, ${full2400.src} 2400w`,
      alt: `${apartmentName} - ${apartmentsContent.sections?.gallery?.photo_label || 'Foto'} ${index + 1}`,
      title: `${apartmentName}`,
    };
  })
);
---

<section class="bg-luxury-white py-12 md:py-16">
  <div class="max-w-7xl mx-auto px-4 sm:px-6">
    <!-- Section heading -->
    <div class="text-center mb-8 md:mb-12">
      <h2 class="text-3xl md:text-4xl font-heading font-medium text-luxury-black mb-4">
        {apartmentsContent.sections?.gallery?.title || "Galleria Fotografica"}
      </h2>
      <div class="w-20 h-0.5 bg-luxury-gold mx-auto mb-4"></div>
      <p class="text-lg text-luxury-graphite max-w-2xl mx-auto">
        {apartmentsContent.sections?.gallery?.subtitle || "Esplora gli spazi e i comfort dell'appartamento attraverso le nostre foto"}
      </p>
    </div>

    <!-- Image carousel -->
    {images.length > 0 ? (
      <div class="max-w-5xl mx-auto">
        <ImageCarousel images={images} loading="lazy" preloadCount={2} />
      </div>
    ) : (
      <div class="text-center text-luxury-graphite">
        <p>{apartmentsContent.sections?.gallery?.no_images || "Nessuna immagine disponibile"}</p>
      </div>
    )}

    <!-- Gallery info -->
    {images.length > 0 && (
      <div class="mt-8 text-center">
        <p class="text-sm text-luxury-graphite">
          <span class="font-medium text-luxury-gold">{images.length} {apartmentsContent.sections?.gallery?.photos_label || 'foto'}</span> {apartmentsContent.sections?.gallery?.available_label || 'disponibili'}
          <span class="mx-2">â€¢</span>
          {apartmentsContent.sections?.gallery?.fullscreen_hint || "Clicca sull'icona di espansione per visualizzare a schermo intero"}
        </p>
      </div>
    )}
  </div>
</section>
