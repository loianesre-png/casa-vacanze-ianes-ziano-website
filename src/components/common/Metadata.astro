---
import merge from 'lodash.merge';
import { SEO } from 'astro-seo';

import type { Props as AstroSeoProps } from 'astro-seo';

import { SITE, METADATA, I18N } from 'astrowind:config';
import type { MetaData } from '~/types';
import { getCanonical } from '~/utils/permalinks';

import { adaptOpenGraphImages } from '~/utils/images';

export interface Props extends MetaData {
  dontUseTitleTemplate?: boolean;
}

const {
  title,
  ignoreTitleTemplate = false,
  canonical = String(getCanonical(String(Astro.url.pathname))),
  robots = {},
  description,
  openGraph = {},
  twitter = {},
} = Astro.props;

const seoProps: AstroSeoProps = merge(
  {
    title: '',
    titleTemplate: '%s',
    canonical: canonical,
    noindex: true,
    nofollow: true,
    description: undefined,
    twitter: {
      cardType: openGraph?.images?.length ? 'summary_large_image' : 'summary',
    },
  },
  {
    title: METADATA?.title?.default,
    titleTemplate: METADATA?.title?.template,
    noindex: typeof METADATA?.robots?.index !== 'undefined' ? !METADATA.robots.index : undefined,
    nofollow: typeof METADATA?.robots?.follow !== 'undefined' ? !METADATA.robots.follow : undefined,
    description: METADATA?.description,
    twitter: METADATA?.twitter,
  },
  {
    title: title,
    titleTemplate: ignoreTitleTemplate ? '%s' : undefined,
    canonical: canonical,
    noindex: typeof robots?.index !== 'undefined' ? !robots.index : undefined,
    nofollow: typeof robots?.follow !== 'undefined' ? !robots.follow : undefined,
    description: description,
    twitter: twitter,
  }
);

// Build openGraph only if we have the required properties (title, type, image)
const finalTitle = seoProps.title || METADATA?.title?.default || SITE?.name || '';
const ogImages = await adaptOpenGraphImages(
  { images: openGraph?.images || METADATA?.openGraph?.images || [] },
  Astro.site
);
const hasRequiredOgProps = finalTitle && ogImages?.images?.length;

const finalOpenGraph = hasRequiredOgProps
  ? {
      basic: {
        title: openGraph?.title || finalTitle,
        type: openGraph?.type || METADATA?.openGraph?.type || 'website',
        image: ogImages.images?.[0]?.url || '',
        url: canonical,
      },
      optional: {
        siteName: SITE?.name,
        locale: I18N?.language || 'en',
        description: seoProps.description,
      },
      image: ogImages.images?.[0]
        ? {
            url: ogImages.images[0].url,
            width: ogImages.images[0].width,
            height: ogImages.images[0].height,
            alt: openGraph?.title || finalTitle,
          }
        : undefined,
    }
  : undefined;
---

<SEO {...seoProps} openGraph={finalOpenGraph} />
