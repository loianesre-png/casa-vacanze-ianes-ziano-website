---
// Optimized Trilocale component with deferred image loading
import ImageCarousel from '../widgets/ImageCarousel.astro';

// Get all images from the trilocale directory
const imageModules = await Astro.glob('../../assets/images/trilocale/*.webp');

// Transform to the format expected by the carousel
const images = imageModules.map((module, index) => ({
  src: module.default,
  alt: `Trilocale apartment view ${index + 1}`,
  title: `Image ${index + 1} of trilocale apartment`,
}));
---

<div class="flex flex-col-reverse lg:flex-row gap-12 max-w-7xl mx-auto p-6">
  <!-- Image carousel section -->
  <div class="w-full lg:w-1/2 flex flex-col gap-6">
    <div 
      class="carousel-container" 
      data-carousel-deferred
    >
      <ImageCarousel 
        images={images} 
        loading="lazy" 
        preloadCount={1}
      />
    </div>
  </div>

  <!-- Apartment information -->
  <div class="w-full lg:w-1/2 space-y-8">
    <!-- Titles -->
    <div>
      <h1 class="text-3xl font-bold mb-2">Ampio Trilocale:</h1>
      <h2 class="text-2xl">2 camere e 2 bagni</h2>
    </div>

    <!-- Description -->
    <div class="space-y-2">
      <div class="flex items-center gap-2">
        <div class="w-6 h-6 rounded-full bg-green-500 flex items-center justify-center">
          <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
        </div>
        <h3 class="text-xl font-medium">Descrizione:</h3>
      </div>
      <p class="text-gray-700 leading-relaxed">
        L'appartamento offre due camere (una matrimoniale e una con due letti singoli), due bagni (uno con doccia) e un
        soggiorno con cucina ben fornita. Perfetto per famiglie o gruppi di amici che desiderano maggiore spazio e
        comfort.
      </p>
    </div>

    <!-- Surface area -->
    <div class="space-y-2">
      <div class="flex items-center gap-2">
        <div class="w-6 h-6 rounded-full bg-green-500 flex items-center justify-center">
          <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M4 8V4m0 0h4M4 4l5 5m11-2V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path>
          </svg>
        </div>
        <h3 class="text-xl font-medium">Superficie:</h3>
      </div>
      <p class="text-gray-700">120 mq</p>
    </div>

    <!-- Capacity -->
    <div class="space-y-2">
      <div class="flex items-center gap-2">
        <div class="w-6 h-6 rounded-full bg-green-500 flex items-center justify-center">
          <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14c-2.67 0-8 1.34-8 4v3h16v-3c0-2.66-5.33-4-8-4z"></path>
          </svg>
        </div>
        <h3 class="text-xl font-medium">Capacit√†:</h3>
      </div>
      <p class="text-gray-700">4 ospiti</p>
    </div>
  </div>
</div>

<!-- Deferred initialization script -->
<script>
  // Initialize carousel only when visible or after page load
  function initCarousel() {
    const carouselContainer = document.querySelector('[data-carousel-deferred]');
    
    if (!carouselContainer) return;

    // Use Intersection Observer for better performance
    if ('IntersectionObserver' in window) {
      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              // Trigger Alpine.js initialization when visible
              carouselContainer.removeAttribute('data-carousel-deferred');
              observer.disconnect();
            }
          });
        },
        {
          rootMargin: '50px', // Start loading 50px before visible
          threshold: 0.01
        }
      );

      observer.observe(carouselContainer);
    } else {
      // Fallback: load after page load
      carouselContainer.removeAttribute('data-carousel-deferred');
    }
  }

  // Run after DOM is ready but before images load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initCarousel);
  } else {
    initCarousel();
  }
</script>

<style>
  /* Show loading state while carousel initializes */
  .carousel-container[data-carousel-deferred] {
    min-height: 400px;
    background: linear-gradient(
      90deg,
      #f0f0f0 0%,
      #f8f8f8 50%,
      #f0f0f0 100%
    );
    background-size: 200% 100%;
    animation: shimmer 1.5s ease-in-out infinite;
    border-radius: 0.5rem;
  }

  @keyframes shimmer {
    0% {
      background-position: -200% 0;
    }
    100% {
      background-position: 200% 0;
    }
  }

  /* Remove shimmer once loaded */
  .carousel-container:not([data-carousel-deferred]) {
    animation: none;
    background: transparent;
  }
</style>